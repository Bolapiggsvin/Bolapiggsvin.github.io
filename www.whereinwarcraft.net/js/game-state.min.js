const MAX_LIVES=3,GUESS_THRESHOLD=2.4,BOD_RADIUS=.8;class GameState{constructor(t,i){this.ui=t,this.panorama=i,this.availableLocations=[]}addLocation(t){this.availableLocations.push(t)}reset(){this.currentRound=0,this.currentLocation=null,this.playerLives=MAX_LIVES,this.playerGuesses=[],this.playerPoints=0,this.isAlive=!0,this.locationPool=[];for(let t of this.availableLocations)this.locationPool.push(t);this.ui.$scoreLives.text(this.playerLives),this.ui.$scoreRounds.text(this.currentRound),this.ui.$scoreAccuracy.text(this.playerAccuracy)}startGame(t){this.reset(),this.ui.enterGame(t,()=>this.nextRound())}restartGame(){this.ui.setGameGlowBorder("transparent"),this.ui.$gameOverSpirit.css("opacity",0),this.ui.$gameOver.fadeOut(400,()=>{this.reset(),this.ui.$gameMap.show(),this.ui.$gameImage.show(),this.nextRound()})}nextRound(){if(this.ui.$scoreAccuracy.text(this.playerAccuracy),this.isAlive)if(this.locationPool.length>0){this.currentRound++,this.ui.$scoreRounds.text(this.currentRound);let t=Math.floor(Math.random()*this.locationPool.length);this.currentLocation=this.locationPool.splice(t,1)[0],this.panorama.setLocation(this.currentLocation.id),this.ui.setGameGlowBorder("transparent"),this.ui.hideMap(),this.ui.clearMap(),this.ui.resetMapZoom(),this.ui.enableMap(),this.ui.$buttonNextRound.hide(),this.ui.$buttonViewLocation.show(),this.ui.$buttonSubmitGuess.show().disable()}else this.ui.showGameOver(!0,this.playerPoints);else this.ui.showGameOver(!1,this.playerPoints)}processGuess(){this.ui.disableMap();let t=this.ui.mapMarker.getLatLng(),i=Util.pointDistance(this.currentLocation.lat,this.currentLocation.lng,t.lat,t.lng),e="blue",s=GUESS_THRESHOLD,o=1-i/GUESS_THRESHOLD;o>0?(o<BOD_RADIUS?e="yellow":(e="green",s=BOD_RADIUS,o=1,this.ui.setGameGlowBorder("green")),this.playerPoints++):(o=0,this.removeLife(),e="red",this.ui.showMapPath(this.currentLocation,t,e),this.ui.setGameGlowBorder("red")),this.ui.setMapInfo(this.currentLocation.zone,this.currentLocation.name);let a=100*o;this.playerGuesses.push(a),this.ui.showMapCircle(this.currentLocation,e,s),this.ui.panMap(this.currentLocation),this.ui.$buttonSubmitGuess.hide(),this.ui.$buttonViewLocation.hide(),this.ui.$buttonNextRound.enable().show()}removeLife(){this.playerLives--,this.isAlive=this.playerLives>0,this.ui.$scoreLives.text(this.playerLives)}get playerAccuracy(){if(0===this.playerGuesses.length)return 0;let t=0;for(let i of this.playerGuesses)t+=i;return Math.ceil(t/this.playerGuesses.length)}}